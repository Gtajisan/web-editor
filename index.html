<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nano Banana AI Editor</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #facc15; border-radius: 10px; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message-bubble { animation: fadeIn 0.3s ease-out forwards; }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #facc15;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        banana: '#facc15',
                        darkbg: '#121212',
                        panel: '#1e1e1e'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-darkbg text-white h-screen flex flex-col overflow-hidden font-sans">

    <!-- Header -->
    <header class="bg-panel border-b border-gray-800 p-4 flex items-center justify-between shadow-lg z-10">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-banana rounded-full flex items-center justify-center text-black font-bold text-xl">
                <i class="fa-solid fa-robot"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg tracking-wide">Nano Banana AI</h1>
                <div class="flex items-center gap-2 text-xs text-green-400">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Online
                </div>
            </div>
        </div>
        <button onclick="toggleSettings()" class="text-gray-400 hover:text-banana transition">
            <i class="fa-solid fa-gear text-xl"></i>
        </button>
    </header>

    <!-- Chat Area -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 pb-20">
        <!-- Welcome Message -->
        <div class="message-bubble flex gap-3">
            <div class="w-8 h-8 bg-banana rounded-full flex-shrink-0 flex items-center justify-center text-black text-xs">AI</div>
            <div class="bg-panel p-3 rounded-r-xl rounded-bl-xl max-w-[80%] text-sm text-gray-200 shadow-md border border-gray-700">
                Hello! üëã I am Nano Banana AI.<br><br>
                1. <b>Upload an image</b> first.<br>
                2. Then type a <b>prompt</b> to edit it.<br>
                <span class="text-xs text-gray-500 mt-2 block italic">Please set your ImgBB API key in settings first.</span>
            </div>
        </div>
    </main>

    <!-- Input Area -->
    <footer class="bg-panel p-4 border-t border-gray-800">
        <div class="max-w-4xl mx-auto flex items-end gap-2 relative">
            
            <!-- Image Upload Input (Hidden) -->
            <input type="file" id="imageInput" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
            
            <!-- Upload Button -->
            <button onclick="document.getElementById('imageInput').click()" class="h-10 w-10 rounded-full bg-gray-700 hover:bg-gray-600 text-banana transition flex items-center justify-center flex-shrink-0">
                <i class="fa-solid fa-image"></i>
            </button>

            <!-- Text Input -->
            <textarea id="promptInput" rows="1" placeholder="Reply to image..." class="w-full bg-darkbg text-white rounded-2xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-banana resize-none overflow-hidden" style="min-height: 40px; max-height: 120px;" oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>

            <!-- Send Button -->
            <button onclick="sendPrompt()" class="h-10 w-10 rounded-full bg-banana hover:bg-yellow-400 text-black transition flex items-center justify-center flex-shrink-0 font-bold transform active:scale-95">
                <i class="fa-solid fa-paper-plane"></i>
            </button>
        </div>
    </footer>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-80 hidden flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-panel p-6 rounded-xl w-96 border border-gray-700 shadow-2xl">
            <h2 class="text-xl font-bold text-banana mb-4">Settings</h2>
            <p class="text-xs text-gray-400 mb-2">Required to convert your local files to URLs for the AI.</p>
            
            <label class="block text-sm font-medium mb-1">ImgBB API Key</label>
            <input type="text" id="apiKeyInput" placeholder="e.g., 39283492..." class="w-full bg-darkbg border border-gray-600 rounded p-2 text-sm mb-4 focus:border-banana outline-none">
            
            <div class="flex justify-end gap-2">
                <button onclick="saveSettings()" class="bg-banana text-black px-4 py-2 rounded font-bold hover:bg-yellow-400">Save</button>
                <button onclick="toggleSettings()" class="bg-gray-700 px-4 py-2 rounded hover:bg-gray-600">Close</button>
            </div>
            <div class="mt-4 text-xs text-gray-500 text-center">
                <a href="https://api.imgbb.com/" target="_blank" class="underline hover:text-banana">Get Free Key Here</a>
            </div>
        </div>
    </div>

    <script>
        // State
        let currentImageURL = null;
        let IMGBB_API_KEY = localStorage.getItem('nano_imgbb_key') || '';

        // UI Elements
        const chatContainer = document.getElementById('chat-container');
        const promptInput = document.getElementById('promptInput');
        const apiKeyInput = document.getElementById('apiKeyInput');

        // Initialize
        if(IMGBB_API_KEY) apiKeyInput.value = IMGBB_API_KEY;
        else toggleSettings(); // Open settings if no key

        // Toggle Settings Modal
        function toggleSettings() {
            const modal = document.getElementById('settingsModal');
            modal.classList.toggle('hidden');
        }

        // Save Settings
        function saveSettings() {
            const key = apiKeyInput.value.trim();
            if(key) {
                localStorage.setItem('nano_imgbb_key', key);
                IMGBB_API_KEY = key;
                toggleSettings();
                addSystemMessage("‚úÖ API Key saved. You can now upload images.");
            } else {
                alert("Please enter a key.");
            }
        }

        // Handle Image Selection
        async function handleImageUpload(input) {
            if (!IMGBB_API_KEY) {
                toggleSettings();
                return alert("Please set your API Key first!");
            }

            const file = input.files[0];
            if (!file) return;

            // Show local preview immediately
            const reader = new FileReader();
            reader.onload = function(e) {
                addUserMessage(null, e.target.result);
            }
            reader.readAsDataURL(file);

            // Show loading state
            const loadId = showLoading("Uploading image...");

            // Upload to ImgBB
            try {
                const formData = new FormData();
                formData.append("image", file);

                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: "POST",
                    body: formData
                });

                const data = await res.json();

                if (data.success) {
                    currentImageURL = data.data.url; // Store for next prompt
                    removeLoading(loadId);
                    addSystemMessage("‚úÖ Image uploaded! Now reply with a prompt.");
                } else {
                    throw new Error(data.error.message || "Upload failed");
                }
            } catch (error) {
                removeLoading(loadId);
                addSystemMessage("‚ùå Upload Error: " + error.message);
            }
            
            // Reset input
            input.value = '';
        }

        // Handle Sending Prompt
        async function sendPrompt() {
            const prompt = promptInput.value.trim();
            
            if (!currentImageURL) {
                return alert("‚ùå Please upload an image first!");
            }
            if (!prompt) {
                return alert("‚ùå Please enter a prompt!");
            }

            // Add User Message
            addUserMessage(prompt);
            promptInput.value = '';
            promptInput.style.height = 'auto';

            // Show Loading
            const loadId = showLoading("Nano Banana is cooking...");

            // Call Tawsif API
            try {
                const apiUrl = `https://tawsif.is-a.dev/gemini/nano-banana?prompt=${encodeURIComponent(prompt)}&url=${encodeURIComponent(currentImageURL)}`;
                
                const response = await fetch(apiUrl);
                const data = await response.json();

                removeLoading(loadId);

                if (data.imageUrl) {
                    // Add Bot Response with Image
                    addBotImage(data.imageUrl);
                    // Update current image context so next prompt edits THIS image
                    currentImageURL = data.imageUrl; 
                } else {
                    addSystemMessage("‚ùå No image URL returned from API.");
                }

            } catch (error) {
                removeLoading(loadId);
                addSystemMessage("‚ùå API Error: " + error.message);
            }
        }

        // UI: Add User Message
        function addUserMessage(text, imageSrc = null) {
            const div = document.createElement('div');
            div.className = "message-bubble flex gap-3 justify-end";
            
            let content = '';
            if(imageSrc) {
                content = `<img src="${imageSrc}" class="max-w-[200px] rounded-xl border border-gray-600">`;
            }
            if(text) {
                content += `<div class="bg-banana text-black p-3 rounded-l-xl rounded-tr-xl max-w-[80%] text-sm shadow-md font-medium">${text}</div>`;
            }

            div.innerHTML = `
                <div class="flex flex-col items-end gap-2">${content}</div>
                <div class="w-8 h-8 bg-gray-700 rounded-full flex-shrink-0 flex items-center justify-center text-white text-xs">You</div>
            `;
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        // UI: Add Bot Image
        function addBotImage(url) {
            const div = document.createElement('div');
            div.className = "message-bubble flex gap-3";
            div.innerHTML = `
                 <div class="w-8 h-8 bg-banana rounded-full flex-shrink-0 flex items-center justify-center text-black text-xs">AI</div>
                 <div class="flex flex-col gap-2">
                    <div class="bg-panel p-2 rounded-r-xl rounded-bl-xl shadow-md border border-gray-700 inline-block">
                        <img src="${url}" class="max-w-[250px] md:max-w-md rounded-lg cursor-pointer hover:opacity-90 transition" onclick="window.open('${url}', '_blank')">
                    </div>
                    <div class="text-xs text-gray-500 ml-1">Reply to edit this image further</div>
                 </div>
            `;
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        // UI: Add System Message
        function addSystemMessage(text) {
            const div = document.createElement('div');
            div.className = "message-bubble flex justify-center my-2";
            div.innerHTML = `<span class="bg-gray-800 text-gray-300 text-xs px-3 py-1 rounded-full border border-gray-700">${text}</span>`;
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        // UI: Loading Indicator
        function showLoading(text) {
            const id = 'load-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "message-bubble flex gap-3 items-center";
            div.innerHTML = `
                <div class="w-8 h-8 bg-banana rounded-full flex-shrink-0 flex items-center justify-center text-black text-xs">AI</div>
                <div class="bg-panel px-4 py-2 rounded-r-xl rounded-bl-xl border border-gray-700 flex items-center gap-3">
                    <div class="loader"></div>
                    <span class="text-sm text-gray-300">${text}</span>
                </div>
            `;
            chatContainer.appendChild(div);
            scrollToBottom();
            return id;
        }

        function removeLoading(id) {
            const el = document.getElementById(id);
            if(el) el.remove();
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Enter key to send
        promptInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendPrompt();
            }
        });
    </script>
</body>
  </html>
